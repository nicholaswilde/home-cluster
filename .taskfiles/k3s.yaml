---
version: '3'

tasks:
  bootstrap:
    desc: Create secret from pass and bootstrap flux
    cmds:
      - kubectl create ns flux-system
      - |
        pass {{ .SECRET }} | \
          kubectl create secret generic sops-gpg \
          --namespace=flux-system \
          --from-file=sops.asc=/dev/stdin
      - |
        flux bootstrap github \
          --owner=$GITHUB_USER \
          --repository={{ .REPO }} \
          --branch=main \
          --path=./cluster \
          --personal
    vars:
      SECRET: gpg/home-cluster-private
      REPO: home-cluster
    silent: true

  taint:
    desc: Taint the main node with CriticalAddonsOnly=true:NoExecute
    cmds:
      - kubectl taint nodes {{ .NAME }} CriticalAddonsOnly=true:NoExecute
    vars:
      NAME:
        sh: >-
          kubectl get nodes -o=jsonpath="{range .items[*]}{.metadata.name}"
          -l node-role.kubernetes.io/master=true
    silent: true

  untaint:
    desc: Untaint the main node with CriticalAddonsOnly=true:NoExecute
    cmds:
      - kubectl taint nodes {{ .NAME }} CriticalAddonsOnly=true:NoExecute-
    vars:
      NAME:
        sh: >-
          kubectl get nodes -o=jsonpath="{range .items[*]}{.metadata.name}"
          -l node-role.kubernetes.io/master=true
    silent: true

  reclaim:
    desc: Change the reclaim policy on a pv
    cmds:
      - >-
        kubectl patch pv {{ .NAME }}
        -p '{"spec":{"persistentVolumeReclaimPolicy":"{{.POLICY}}"}}'
    vars:
      POLICY: Retain
    deps:
      - _check-name

  _check-name:
    cmds:
      - test ! -z "{{ .NAME }}" || (echo "NAME is not set"; exit 1;)
    silent: true
