---
version: '3'

env:
  ANSIBLE_CONFIG: "{{.PROJECT_DIR}}/server/ansible/ansible.cfg"

vars:
  ANSIBLE_PLAYBOOK_DIR: "{{.ANSIBLE_DIR}}/playbooks"
  ANSIBLE_INVENTORY_DIR: "{{.ANSIBLE_DIR}}/inventory"
  ANSIBLE_GROUPS: "main:node"
  ANSIBLE_INVENTORY: "cluster"

tasks:

  ping:
    desc: Ping all the k3s nodes
    cmds:
      - >-
        ansible "{{.ANSIBLE_GROUPS}}"
        -i "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}/hosts.yaml"
        --one-line -m ping
    silent: true

  list:
    desc: List all the k3s nodes
    dir: "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}"
    cmds:
      - ansible "{{.ANSIBLE_GROUPS}}" -i "./hosts.yaml" --list-hosts
    silent: true

  upgrade:
    desc: Upgrade all the k3s node's operating system
    cmds:
      - >-
        ansible-playbook
        -i "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}/hosts.yaml"
        "{{.ANSIBLE_PLAYBOOK_DIR}}/upgrade.yaml"
        -l {{ .ANSIBLE_GROUPS }}
    silent: true

  reboot:
    desc: Reboot all the k3s nodes
    cmds:
      - >-
        ansible "{{.ANSIBLE_GROUPS}}"
        -i "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}/hosts.yaml"
        -m reboot
    silent: true

  requirements:
    desc: Download all ansible requirements
    cmds:
      - "ansible-galaxy install -r {{.ANSIBLE_DIR}}/requirements.yaml"
    silent: true

  prepare:
    desc: Prepare the cluster for K3s installation
    cmds:
      - >-
        ansible-playbook
        -i "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}/hosts.yaml"
        "{{.ANSIBLE_PLAYBOOK_DIR}}/prepare.yaml"
    slient: true

  install:
    desc: Install K3s
    cmds:
      - >-
        ansible-playbook
        -i "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}/hosts.yaml"
        "{{.ANSIBLE_PLAYBOOK_DIR}}/install.yaml"
    slient: true

  nuke:
    desc: Nuke K3s
    cmds:
      - >-
        ansible-playbook
        -i "{{.ANSIBLE_INVENTORY_DIR}}/{{ .ANSIBLE_INVENTORY }}/hosts.yaml"
        "{{.ANSIBLE_PLAYBOOK_DIR}}/nuke.yaml"
    slient: true

  vars:
    desc: Print vars
    cmds:
      - printf "%s  %s\n" "ANSIBLE_PLAYBOOK_DIR" "{{ .ANSIBLE_PLAYBOOK_DIR }}"
      - printf "%s %s\n" "ANSIBLE_INVENTORY_DIR" "{{ .ANSIBLE_INVENTORY_DIR }}"
      - printf "%s        %s\n" "ANSIBLE_GROUPS" "{{ .ANSIBLE_GROUPS }}"
      - printf "%s     %s\n" "ANSIBLE_INVENTORY" "{{ .ANSIBLE_INVENTORY }}"
    silent: true
